<!DOCTYPE html>
<html>
    <head>
      <base target="_top">
      <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
      <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

      <?!= include('Style'); ?>
    </head>
  <body>
    
    <div class="sidebar">
      <div class="logo-area">
        <i class="fas fa-bolt"></i> <span>SETORAN PAJ</span>
      </div>
      
      <ul class="menu-list">
        <li onclick="showPage('dashboard')" class="active" id="nav-dashboard">
          <i class="fas fa-home"></i> <span>Dashboard</span>
        </li>
        <li onclick="showPage('input')" id="nav-input">
          <i class="fas fa-pen-to-square"></i> <span>Input Transaksi</span>
        </li>
        <li onclick="showPage('report')" id="nav-report">
          <i class="fas fa-chart-line"></i> <span>Laporan</span>
        </li>
      </ul>
    </div>

      <div class="main-content">
        
        <div class="topbar">
          <div style="display:flex; align-items:center;">
              <div class="menu-toggle" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i>
              </div>
              <div class="page-title" id="pageTitle">Dashboard Overview</div>
          </div>
          
          <div class="user-info">
            <span class="desktop-only">PT PANJI ALAM JAYA</span> <div class="avatar">PAJ</div>
          </div>
        </div>

        <div id="page-dashboard" class="page-section">
          
          <div class="filter-card">
            <label>Periode:</label>
            <select id="filterPreset" onchange="applyDatePreset(this.value)" style="margin-right: 10px; border: 1px solid #ddd; border-radius: 50px; padding: 8px 15px;">
                <option value="default">Filter Cepat</option>
                <option value="today">Hari Ini</option>
                <option value="yesterday">Kemarin</option>
                <option value="last7">7 Hari Terakhir</option>
                <option value="thisMonth">Full Bulan Ini</option>
                <option value="lastMonth">Bulan Kemarin</option>
            </select>
            <div class="date-wrapper">
              <input type="date" id="dashStart"> 
              <span class="date-divider">s/d</span> 
              <input type="date" id="dashEnd">
            </div>
            <button onclick="loadDashboard()">Filter</button>
          </div>

          <div class="cards-grid">
            <div class="card stat-card">
              <h3>Pemasukan</h3>
              <h2 class="text-green" id="dashIn">Rp 0</h2>
            </div>
            <div class="card stat-card">
              <h3>Pengeluaran</h3>
              <h2 class="text-red" id="dashOut">Rp 0</h2>
            </div>
            <div class="card stat-card">
              <h3>Cash / Tunai</h3>
              <h2 class="text-blue" id="dashCash">Rp 0</h2>
            </div>
            <div class="card stat-card">
              <h3>Saldo Akhir</h3>
              <h2 class="text-bold" id="dashSaldo">Rp 0</h2>
            </div>
          </div>

          <div class="dashboard-row" style="margin-bottom: 25px;">
            
            <div class="card" style="flex: 1;">
              <h4 style="margin-bottom: 15px; font-size: 16px; color: #333;">
                <i class="fas fa-chart-pie" style="color: #1e6f48; margin-right: 8px;"></i> Rincian Pemasukan
              </h4>
              <div class="table-responsive">
                <table class="table table-compact" id="tableRincianMasuk">
                  <tbody></tbody>
                </table>
              </div>
            </div>

            <div class="card" style="flex: 1;">
              <h4 style="margin-bottom: 15px; font-size: 16px; color: #333;">
                <i class="fas fa-university" style="color: #0984e3; margin-right: 8px;"></i> Saldo Rekening (Real)
              </h4>
              <div class="table-responsive">
                <table class="table table-compact" id="tableBankSaldo">
                  <tbody></tbody>
                </table>
              </div>
            </div>

          </div>

          <div class="dashboard-row">
            
            <div class="card table-card" style="flex: 2;">
              <h4>Performa Cabang</h4>
              <div class="table-responsive">
                <table class="table" id="tableCabang">
                  <thead>
                    <tr><th>Cabang</th><th>Masuk</th><th>Keluar</th><th>Saldo</th></tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>

            <div class="card table-card" style="flex: 1;">
              <h4 class="text-red" style="border-bottom: 2px solid #ffe5e5; padding-bottom: 10px;">
                <i class="fas fa-wallet"></i> Top Pengeluaran
              </h4>
              <div class="table-responsive">
                <table class="table" id="tableRincianKeluar">
                  <thead>
                    <tr>
                      <th>Kategori</th>
                      <th style="text-align:right;">Jumlah</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>

          </div>

        </div> 

      <div id="page-input" class="page-section hidden">
        <div class="input-container">
          
          <div class="card" style="flex: 1;">
            <h4>Form Transaksi</h4>
            
            <div class="form-group">
              <label>Tanggal</label>
              <input type="date" id="inputDate" onchange="updateAvailableBranches()">
            </div>

            <div class="form-group">
              <label>Cabang</label>
              <select id="inputCabang" onchange="checkDistributorStats(this); checkNewMaster(this, 'cabang')"></select>
              
              <div id="distributorInfo" class="hidden" style="margin-top: 10px; padding: 10px; background-color: #e3f2fd; border: 1px dashed #2196f3; border-radius: 8px; color: #0d47a1;">
                <div style="font-size: 11px; font-weight: bold; text-transform: uppercase;">Saldo Kas Seluruh Cabang (Global)</div>
                <div id="distributorSaldo" style="font-size: 18px; font-weight: 800; color: #0d47a1;">Rp 0</div>
                <small style="color: #666;">*Angka ini adalah akumulasi saldo dari semua cabang.</small>
              </div>
            </div>

            <div class="form-group">
              <label>Tipe Transaksi</label>
              
              <div class="trx-tabs">
                <div id="tabMasuk" class="tab-item active-masuk" onclick="setTrxType('Pemasukan')">
                  <i class="fas fa-arrow-down"></i> Pemasukan
                </div>
                
                <div id="tabKeluar" class="tab-item" onclick="setTrxType('Pengeluaran')">
                  <i class="fas fa-arrow-up"></i> Pengeluaran
                </div>
              </div>

              <input type="hidden" id="inputType" value="Pemasukan">
            </div>

            <div class="form-group">
              <label>Kategori</label>
              <select id="inputKategori" onchange="checkNewMaster(this, 'kategori')"></select>
            </div>

            <div class="form-group">
              <label>Metode Pembayaran</label>
              
              <select id="inputMetode" onchange="checkNewMaster(this, 'metode'); checkMethodBalance()"></select>
              
              <div id="methodSaldoInfo" class="hidden" style="margin-top: 8px; padding: 10px 15px; background-color: #f3e5f5; border: 1px dashed #ab47bc; border-radius: 10px; color: #6a1b9a; display: flex; align-items: center; justify-content: space-between;">
                
                <div style="font-size: 12px; font-weight: 600;">
                  <i class="fas fa-wallet" style="margin-right:5px;"></i> Sisa Saldo <span id="labelMetode">...</span> :
                </div>
                
                <div id="valMetodeSaldo" style="font-size: 16px; font-weight: 800;">Rp 0</div>
              </div>

            </div>

            <div class="form-group">
              <label>Nominal (Rp)</label>
              <input type="text" id="inputNominal" placeholder="0" onkeyup="formatRibuan(this)">
            </div>

            <div class="form-group">
              <label>Keterangan</label>
              <input type="text" id="inputKet" placeholder="Deskripsi singkat">
            </div>

            <button class="btn-primary" onclick="addToBuffer()">+ Tambah ke List</button>
          </div>

          <div class="card" style="flex: 2;">
            <h4>Draft Transaksi (Buffer)</h4>
              <table class="table" id="bufferTable">
                <thead>
                  <tr>
                    <th style="width: 5%;"></th> <th>Tipe</th>
                    <th>Ket</th>
                    <th>Nominal</th>
                    <th>Aksi</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            
              <div class="buffer-footer">
                <div style="flex: 1;">
                  Total: <span id="bufferTotal">Rp 0</span>
                </div>

                <div id="footerActionBtns" style="display:flex; gap:10px;">
                  <button class="btn-success" onclick="saveAll()">SIMPAN SEMUA</button>
                </div>
              </div>
          </div>
        </div>
      </div>

<div id="page-report" class="page-section hidden">
        <div class="card">
          
          <div class="report-header">
            <h4>Laporan Rekap Per Cabang</h4>
            
              <div class="report-controls">
                
              <div class="filter-group">
                <select id="repCabang" onchange="loadReport()">
                  <option value="">Semua Cabang</option>
                </select>
                
                <select id="reportPreset" onchange="applyReportPreset(this.value)">
                  <option value="">Filter Cepat</option>
                  <option value="today">Hari Ini</option>
                  <option value="yesterday">Kemarin</option>
                  <option value="last7">7 Hari Terakhir</option>
                  <option value="thisMonth">Bulan Ini</option>
                  <option value="lastMonth">Bulan Kemarin</option>
                </select>
                <input type="date" id="repStart">
                <span class="date-sep">-</span>
                <input type="date" id="repEnd">
                
                <button class="btn-filter" onclick="loadReport()">
                  <i class="fas fa-filter"></i> Filter
                </button>
              </div>

                <div class="export-group">
                  <button class="btn-laba" onclick="askExportFormat()">
                    <i class="fas fa-file-invoice-dollar"></i> Export Rekap
                  </button>
                  
                  <button class="btn-excel" onclick="generateFullRekap('excel')">
                    <i class="fas fa-file-excel"></i> Full Excel
                  </button>
                  
                  <button class="btn-pdf" onclick="generateFullRekap('print')">
                    <i class="fas fa-file-pdf"></i> Full PDF
                  </button>
                </div>

              </div>
          </div>
          <div style="display:flex; justify-content:flex-start; margin-bottom:15px;">
            <div class="trx-tabs" style="width: 300px;">
              <div id="tabRepDaily" class="tab-item active-masuk" onclick="setReportMode('daily')">
                  <i class="fas fa-calendar-day"></i> Per Hari
              </div>
              <div id="tabRepAccum" class="tab-item" onclick="setReportMode('accumulated')">
                  <i class="fas fa-layer-group"></i> Akumulasi
              </div>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table" id="reportTable">
              <thead>
                <tr>
                  <th>Tanggal</th>
                  <th>Cabang</th>
                  <th>Total Pemasukan</th>
                  <th>Total Pengeluaran</th>
                  <th>Saldo</th>
                  <th>Aksi</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

<div id="modalDetailTrx" class="modal">
      <div class="modal-content compact-modal" style="width: 650px; max-width: 95%; padding: 0;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:10px;">
           <h4 id="detailTitle" style="margin:0; text-align:left;">Detail Transaksi</h4>
           <button onclick="closeDetail()" style="background:none; border:none; font-size:24px; cursor:pointer; color:#999;">&times;</button>
        </div>
        
        <div class="table-responsive" style="max-height: 500px; overflow-y: auto; padding-right:5px;">
          <table class="table table-compact" id="tableDetailContent" style="width:100%;">
            <thead style="background:#eee; font-size:12px;">
              <tr>
                <th style="width:25%;">Kategori & Tipe</th>
                <th style="width:40%;">Keterangan (Edit)</th>
                <th style="width:25%; text-align:right;">Nominal (Edit)</th>
                <th style="width:10%; text-align:center;">Hapus</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="modal-actions" style="margin-top: 25px; border-top:1px solid #eee; padding-top:20px;">
          </div>
      </div>
    </div>

    </div>

    <div id="modalMaster" class="modal">
      <div class="modal-content">
        <h4>Tambah Data Baru</h4>
        <input type="hidden" id="modalType">
        <input type="text" id="modalValue" placeholder="Masukkan Nama Baru">
        <div class="modal-actions">
          <button onclick="closeModal()">Batal</button>
          <button class="btn-primary" onclick="saveMasterData()">Simpan</button>
        </div>
      </div>
    </div>

    <div id="printArea"></div>
      <div id="globalLoader" class="loading-overlay hidden">
            <div class="spinner"></div>
            <div class="loading-text">Mohon Menunggu...</div>
          </div>

    <?!= include('Javascript'); ?>
  </body>
</html>
